	INTEGER*4 FUNCTION PTRATE(PT,RATNG,NPAIRS)
C PT is the value to be rated
C RATNG is NPAIRS unrated values followed by NPAIRS rated values
	
      IMPLICIT NONE  ! 30/03/2004 ITB 
      
      
      INTEGER*4 PT,RATNG(*)
      INTEGER*4 NPAIRS,K1,J ! 30/03/2004 ITB  
      
      
      REAL X1(3),Y1(3),C(7)
	REAL X,SQT  ! 30/03/2004 ITB !RAW REAL
      REAL  C1,C2,C3,C4,C5,C6,C7  ! 30/03/2004 ITB  !RAW REAL
      
      
      EQUIVALENCE (C1,C(1)),(C2,C(2)),(C3,C(3)),(C4,C(4)),
     1	(C5,C(5)),(C6,C(6)),(C7,C(7))
C
	K1=1
	J=NPAIRS-1
	IF(PT.LT.RATNG(2))GOTO 330
300	K1=K1+1
	IF(PT.GT.RATNG(K1+1).AND.K1.LT.J) GO TO 300
	X1(1)=RATNG(K1-1)
	X1(2)=RATNG(K1)
	X1(3)=RATNG(K1+1)
	K1=K1+NPAIRS
	Y1(1)=RATNG(K1-1)
	Y1(2)=RATNG(K1)
	Y1(3)=RATNG(K1+1)
C	CALL CURVE(X1,Y1,C1,2)  ! DGT 5/14/12 Replaced by below to get to compile
      CALL CURVE(X1,Y1,C,2)
	GO TO 340
330	X1(1)=RATNG(1)
	X1(2)=RATNG(2)
	X1(3)=RATNG(3)
	Y1(1)=RATNG(NPAIRS+1)
	Y1(2)=RATNG(NPAIRS+2)
	Y1(3)=RATNG(NPAIRS+3)
c	CALL CURVE(X1,Y1,C1,1)  ! DGT 5/14/12 Replaced by below to get to compile
      CALL CURVE(X1,Y1,C,1)
340	X=PT
	SQT=SQRT(C4*(X-C5))
	X=C1*(X-C2)*(X-C2)+C3*SQT+C6*X+C7
	PTRATE=X+SIGN(0.5,X)
	END
C
	SUBROUTINE CURVE(XX,YY,CC,K)
C		Finds Formula for Quadratic on three Points
C 29-10-82 CONDITION FOR STRAIGHT LINE CHANGED TO AVOID OVERFLOW
C           FROM 0.99995 TO 0.9995
C	MOUSE PUT SOME COMMENTS IN CAUSE HE DIDN'T UNDERSTAND IT
C
C	CURVE IS PASSED TWO ARRAYS X & Y, X IS THE INDEPENDENT VARIABLE
C	IT SENDS BACK SEVEN CONSTANTS WHICH ARE BECOME A MAGIC FORMULA USED
C	FOR INTERPOLATION AT THE DESIRED X-VALUE. FOR SPEED, THE ARRAYS ARE
C	COPIED INTO STATIC STORAGE.
C
C	K = CONTROL VALUE TO INDICATE WHETHER CURVE USES A LEFT OR RIGHT
C	QUADRATIC. IF HAVE N POINTS THEN USE RIGHT FORM (K=2) UNLESS THE
C	POINT TO BE INTERPOLATED IS LESS THAN X2. THEN USE K=1
      IMPLICIT NONE   ! 30/03/2004 ITB 
      
      INTEGER*4  I,K  ! 30/03/2004 ITB  
          
      REAL X(3),Y(3),C(7),x1,x2,x3,y1,y2,y3,c1,c2,c3,c4,c5,c6,c7 !RAW REAL
      REAL s1,s2,x21,x32,x31 !RAW REAL
      REAL XX(3),YY(3),CC(7)
      EQUIVALENCE (X1,X(1)),(X2,X(2)),(X3,X(3))
      EQUIVALENCE (Y1,Y(1)),(Y2,Y(2)),(Y3,Y(3))
      EQUIVALENCE (C1,C(1)),(C2,C(2)),(C3,C(3)),(C4,C(4)),(C5,C(5)),
     * (C6,C(6)),(C7,C(7))
C		Initialise
       DO 10 I=1,3
       X(I)=XX(I)
       Y(I)=YY(I)
  10   C(I)=0.0
       C(4)=0.0
       C(5)=0.0
       C(6)=0.0
       C(7)=0.0
C
C	CORRECT FOR NON-MONOTONIC RATING CURVES
	X21=X2-X1
	IF(ABS(X21) .LT. 0.1)X21=DSIGN(0.1d0,X21)
       S1=(Y2-Y1)/X21
	X32=X3-X2
	IF (ABS(X32) .LT. 0.1) X32=DSIGN(0.1d0,X32)
       S2=(Y3-Y2)/X32
	X31=X3-X1
	IF(ABS(X31) .LT. 0.1)X31=DSIGN(0.1d0,X31)
C
C	CHECK IF THE LINES LINKING THE THREE POINTS HAVE THE SAME SIGN
C	OF SLOPE
       IF (S1*S2.GT.0.0) GO TO 30
C		Quadratic with maximum curvature at (X2,Y2)
       C2=X2
       C7=Y2
       IF (K.EQ.2) GO TO 20
       C1=-S1/X21
       GO TO 90
  20   C1=S2/X32
       GO TO 90
30	IF(S2/S1.LT.0.9995) GO TO 50
	IF (S2/S1.GT.1.0005) GO TO 60
C		Straight Line
      IF (K.EQ.2) GO TO 40
       C6=S1
       C7=Y1-S1*X1
       GO TO 90
  40   C6=S2
       C7=Y3-S2*X3
       GO TO 90
  50   GO TO (80,70),K
  60   GO TO (70,80),K
C		X-on-Y Quadratic
  70   C4=(Y3-Y1)/(1./S2-1./S1)
       C7=(S2*(Y3+Y2)-S1*(Y2+Y1))/(S2-S1)*0.5
       C5=X2-(Y2-C7)*(Y2-C7)/C4
       IF (K.EQ.1) C3=-DSIGN(1.0d0,S1)
       IF (K.EQ.2) C3=DSIGN(1.0d0,S1)
       GO TO 90
C		Y-on-X Quadratic
  80   C1=(S2-S1)/X31
       C2=(S1*(X3+X2)-S2*(X2+X1))/(S1-S2)*0.5
       C7=Y2-C1*(X2-C2)*(X2-C2)
C
  90   DO 100 I=1,7
  100  CC(I)=C(I)
       END
